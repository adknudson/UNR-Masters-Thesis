```{r ch5_4-setup, include=FALSE}
library(FangPsychometric)
library(dplyr)
library(rstan)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

av_dat <- audiovisual_binomial %>%
  filter(trial %in% c("pre", "post1"),
         rid != "av-post1-O-f-CE") %>%
  mutate(trt = droplevels(trial),
         sid = droplevels(sid))
```


## Iteration 3 (The one for Me)

In this iteration of the model building process, we are going to add the individual subjects into the multilevel model, and because this is a simple addition, we are going to skip the prior predictive simulations. 

### Model Development

```{r}
obs_dat3 <- list(N = nrow(av_dat),
                 N_G = max(as.integer(av_dat$age_group)),
                 N_T = max(as.integer(av_dat$trt)),
                 N_S = max(as.integer(av_dat$sid)),
                 x = av_dat$soa / 1000,
                 k = av_dat$k,
                 n = av_dat$n,
                 G = as.integer(av_dat$age_group),
                 trt = as.integer(av_dat$trt),
                 S = as.integer(av_dat$sid))

av_iter3_obs_fit <- stan_model("models/av_iter3_obs_fit.stan",
                               model_name = "av_iter3_obs_fit")

av_iter3_start <- replicate(6, list(a = 0, 
                                    aG = rep(0, obs_dat3$N_G), 
                                    aT = rep(0, obs_dat3$N_T), 
                                    aS = rep(0, obs_dat3$N_S),
                                    b = 2.5,
                                    bG = rep(0, obs_dat3$N_G),
                                    bT = rep(0, obs_dat3$N_T),
                                    bS = rep(0, obs_dat3$N_S)),
                            simplify = FALSE)

m3_fit <- sampling(av_iter3_obs_fit, data = obs_dat3, 
                   iter = 7500, warmup = 2500, refresh = 2500,
                   chains = 6, init = av_iter3_start,
                   control = list(adapt_delta=0.95, max_treedepth=12))
```


### Diagnose posterior fit

```{r}
check_hmc_diagnostics(m3_fit)
```

### Posterior retrodictive checks

```{r}
post <- extract(m3_fit)
```

```{r}
post_k_pred <- t(apply(post$y_post_pred, 2, quantile,
                          probs = c(1.5, 5.5, 50, 94.5, 98.5) / 100))

idx <- sample(1:nrow(post$y_post_pred), 1)

pred <- cbind(post_k_pred, 
              post_mean = colMeans(post$y_post_pred),
              post_rand = post$y_post_pred[idx,]) %>%
  sweep(1, obs_dat3$n, FUN = "/") %>%
  bind_cols(obs_dat3) %>%
  select(-N) %>%
  mutate(p = k / n)
```


```{r}
pred %>%
  ggplot(aes(x, p)) +
  geom_jitter(width = 0.0125, height = 0.01,
              col = rgb(123, 28, 212, maxColorValue = 255)) +
  geom_jitter(aes(y = post_rand), 
              col = rgb(28, 214, 68, 120, maxColorValue = 255),
              width = 0.0125, height = 0.01) +
  facet_grid(G ~ trt)
```


```{r}
av_iter4_obs_fit <- stan_model("models/av_iter4_obs_fit.stan",
                               model_name = "av_iter4_obs_fit")

m4_fit <- sampling(av_iter4_obs_fit, data = obs_dat3, 
                   iter = 7500, warmup = 2500, refresh = 100,
                   chains = 6,
                   control = list(adapt_delta=0.95, max_treedepth=12))

check_hmc_diagnostics(m4_fit)
```

### Posterior retrodictive checks

```{r}
post <- extract(m4_fit)
```

```{r}
post_k_pred <- t(apply(post$y_post_pred, 2, quantile,
                          probs = c(1.5, 5.5, 50, 94.5, 98.5) / 100))

idx <- sample(1:nrow(post$y_post_pred), 1)

pred <- cbind(post_k_pred, 
              post_mean = colMeans(post$y_post_pred),
              post_rand = post$y_post_pred[idx,]) %>%
  sweep(1, obs_dat3$n, FUN = "/") %>%
  bind_cols(obs_dat3) %>%
  select(-N) %>%
  mutate(p = k / n)

print(pred, n = 21)
```


```{r}
pred %>%
  ggplot(aes(x, p)) +
  geom_jitter(width = 0.0125, height = 0.01,
              col = rgb(123, 28, 212, maxColorValue = 255)) +
  geom_jitter(aes(y = post_rand), 
              col = rgb(28, 214, 68, 120, maxColorValue = 255),
              width = 0.0125, height = 0.01) +
  facet_grid(G ~ trt)
```
